<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 5 Stars Leaderboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Neue', cursive;
            background: linear-gradient(135deg, #6ecbf5 0%, #e3f2fd 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            color: white;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="50,5 63,38 98,38 69,59 82,95 50,75 18,95 31,59 2,38 37,38" fill="rgba(255,255,255,0.2)"/></svg>');
            background-size: 60px;
            opacity: 0.6;
            z-index: -1;
        }

        h1 {
            font-family: 'Baloo 2', cursive;
            font-size: 3rem;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            font-size: 1.1rem;
            flex-wrap: wrap;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            min-width: 220px;
        }

        .tabs-container {
            overflow-x: auto;
            margin-bottom: 25px;
            padding-bottom: 5px;
            scrollbar-width: thin;
            scrollbar-color: #3498db #f0f0f0;
        }

        /* Students panel table styles */
        #students-panel table { width: 100%; border-collapse: collapse; }
        #students-panel th, #students-panel td { padding: 10px; border-bottom: 1px solid #e0e0e0; text-align: left; }
        #students-panel thead th { background: #3498db; color: white; font-weight: 700; }
        #students-panel h3 { margin-top: 0; }
        #students-panel .student-management-btn { margin-left: 10px; }

        .tabs-container::-webkit-scrollbar {
            height: 8px;
        }

        .tabs-container::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }

        .tabs {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            padding: 5px 0;
            width: max-content;
            min-width: 100%;
        }

        .tab {
            padding: 12px 18px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50px;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: #f1c40f;
            color: #2c3e50;
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .tab.active::after {
            content: "â˜…";
            position: absolute;
            top: -8px;
            right: 5px;
            font-size: 1.5rem;
            animation: twinkle 1.5s infinite;
        }

        .leaderboard-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .leaderboard-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(90deg, #3498db, #e74c3c, #f1c40f, #2ecc71, #9b59b6);
            border-radius: 10px 10px 0 0;
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .leaderboard-title {
            font-family: 'Baloo 2', cursive;
            font-size: 1.8rem;
            color: #3498db;
        }

        .reset-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 25px;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reset-btn:hover {
            background: #c0392b;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            font-size: 1.1rem;
        }

        th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 700;
            position: sticky;
            top: 0;
        }

        th:first-child {
            border-radius: 12px 0 0 0;
        }

        th:last-child {
            border-radius: 0 12px 0 0;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:nth-child(odd) {
            background-color: #ffffff;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .rank {
            font-weight: 700;
            text-align: center;
            font-size: 1.3rem;
            width: 50px;
        }

        .rank-1 { 
            background: linear-gradient(to right, #f1c40f, #ffd700);
            color: #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        .rank-2 { 
            background: linear-gradient(to right, #95a5a6, #bdc3c7);
            color: #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        .rank-3 { 
            background: linear-gradient(to right, #e67e22, #d35400);
            color: #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }

        .student-name {
            font-weight: 700;
        }

        .gender-icon {
            display: inline-block;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 10px;
            font-size: 14px;
        }

        .boy .gender-icon {
            background: #3498db;
            color: white;
        }

        .girl .gender-icon {
            background: #e84393;
            color: white;
        }

        .stars {
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 120px;
        }

        .star {
            color: #f1c40f;
            font-size: 1.3rem;
        }

        .points-input {
            width: 70px;
            padding: 8px 12px;
            border: 2px solid #3498db;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
            font-family: 'Comic Neue', cursive;
            transition: all 0.3s ease;
        }

        .points-input:focus {
            outline: none;
            border-color: #f1c40f;
            box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.3);
        }

        .save-notice {
            text-align: center;
            padding: 15px;
            background: #2ecc71;
            color: white;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 700;
            display: none;
            animation: fadeInOut 3s ease;
        }

        .reset-notice {
            text-align: center;
            padding: 15px;
            background: #3498db;
            color: white;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 700;
            display: none;
            animation: fadeInOut 3s ease;
        }

        .add-stars-btn {
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
            white-space: nowrap;
        }

        .add-stars-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 50px;
            position: absolute;
            top: 20px;
            right: 20px;
            backdrop-filter: blur(5px);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f1c40f;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 8px 16px;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .student-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
            position: relative;
        }

        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .student-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 15px;
        }

        .girl .student-avatar {
            background: #e84393;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-stars {
            font-size: 1.2rem;
            font-weight: bold;
            color: #f1c40f;
        }

        .floating-add-stars {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 100;
        }

        .floating-add-stars:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .student-management {
            margin: 25px 0;
            text-align: center;
        }

        .student-management-btn {
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 25px;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 0 10px;
        }

        .student-management-btn:hover {
            background: #8e44ad;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .modal-title {
            font-family: 'Baloo 2', cursive;
            font-size: 1.8rem;
            color: #3498db;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            position: absolute;
            top: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-family: 'Comic Neue', cursive;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .student-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 2;
        }

        .student-action-btn {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .student-action-btn:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* New styles for rank badges */
        .student-rank {
            display: flex;
            align-items: center;
            margin-top: 5px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .rank-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .warrior-explorer { background: linear-gradient(45deg, #8B4513, #A0522D); color: white; }
        .elite-apprentice { background: linear-gradient(45deg, #C0C0C0, #D3D3D3); color: #333; }
        .master-scholar { background: linear-gradient(45deg, #FFD700, #DAA520); color: #333; }
        .grandmaster-achiever { background: linear-gradient(45deg, #00BFFF, #1E90FF); color: white; }
        .epic-strategist { background: linear-gradient(45deg, #9370DB, #8A2BE2); color: white; }
        .legend-mastermind { background: linear-gradient(45deg, #FF8C00, #FF4500); color: white; }
        .mythic-luminary { background: linear-gradient(45deg, #FF1493, #C71585); color: white; }
        .mythical-visionary { background: linear-gradient(45deg, #9400D3, #4B0082); color: white; }
        .mythical-prodigy { background: linear-gradient(45deg, #00CED1, #008B8B); color: white; }
        .mythical-immortal { background: linear-gradient(45deg, #FF0000, #8B0000); color: white; }

        .rank-column {
            min-width: 180px;
        }

        @keyframes twinkle {
            0% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.5; transform: scale(1); }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }

        @media (max-width: 768px) {
            .stats {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .stat-box {
                width: 100%;
                max-width: 300px;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 1rem;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .points-input {
                width: 60px;
                padding: 6px;
            }
            
            .student-list {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .reset-btn {
                width: 100%;
                justify-content: center;
            }
            
            .user-info {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-top: 15px;
                width: 100%;
            }

            .floating-add-stars {
                display: flex;
            }

            td:nth-child(4) {
                position: sticky;
                right: 0;
                background: inherit;
                z-index: 1;
            }

            td:nth-child(4)::after {
                content: "";
                position: absolute;
                top: 0;
                left: -5px;
                width: 5px;
                height: 100%;
                background: linear-gradient(to left, rgba(0,0,0,0.1), transparent);
            }

            .student-management-btn {
                width: 100%;
                margin: 10px 0;
                justify-content: center;
            }
            
            .rank-column {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Grade 5 Student Star Leaderboard</h1>
            <div class="subtitle">Celebrating Excellence in Learning</div>
            <!-- Spin The Wheel Tab -->
            <div style="margin-top: 18px;">
                <a href="roleta.html" style="
                    display: inline-block;
                    background: #e74c3c;
                    color: white;
                    padding: 10px 28px;
                    border-radius: 50px;
                    font-family: 'Comic Neue', cursive;
                    font-weight: 700;
                    font-size: 1.1rem;
                    text-decoration: none;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    transition: background 0.3s;
                    margin-right: 10px;
                " onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">
                    <i class="fas fa-sync-alt"></i> Spin The Wheel
                </a>
                <!-- Timer Tab -->
                <a href="timer.html" style="
                    display: inline-block;
                    background: #2ecc71;
                    color: white;
                    padding: 10px 28px;
                    border-radius: 50px;
                    font-family: 'Comic Neue', cursive;
                    font-weight: 700;
                    font-size: 1.1rem;
                    text-decoration: none;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    transition: background 0.3s;
                    margin-right: 10px;
                " onmouseover="this.style.background='#27ae60'" onmouseout="this.style.background='#2ecc71'">
                    <i class="fas fa-clock"></i> Timer
                </a>
                <!-- Reading Progress Tracker Tab -->
                <a href="dashboard.html" style="
                    display: inline-block;
                    background: #f1c40f;
                    color: #2c3e50;
                    padding: 10px 28px;
                    border-radius: 50px;
                    font-family: 'Comic Neue', cursive;
                    font-weight: 700;
                    font-size: 1.1rem;
                    text-decoration: none;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    transition: background 0.3s;
                " onmouseover="this.style.background='#ffe066'" onmouseout="this.style.background='#f1c40f'">
                    <i class="fas fa-book-reader"></i> Reading Progress Tracker
                </a>
            </div>
            
            <div class="user-info" id="user-info">
                <div class="user-avatar" id="user-avatar">T</div>
                <span id="user-name">Teacher</span>
                <span id="logged-in-user"></span>
                <button class="logout-btn" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Log Out
                </button>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <i class="fas fa-book"></i> Active Subject: <span id="active-subject">English</span>
                </div>
                <div class="stat-box">
                    <i class="fas fa-star"></i> Total Stars: <span id="total-stars">142</span>
                </div>
                <div class="stat-box">
                    <i class="fas fa-crown"></i> Top Student: <span id="top-student">DEHILO, ALDRIN LOMA</span>
                </div>
            </div>
        </header>
        
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-class="overall">Overall Stars</button>
                <button class="tab" data-class="english">English</button>
                <button class="tab" data-class="filipino">Filipino</button>
                <button class="tab" data-class="mathematics">Mathematics</button>
                <button class="tab" data-class="science">Science</button>
                <button class="tab" data-class="aralingPanlipunan">Araling Panlipunan</button>
                <button class="tab" data-class="epp">EPP</button>
                <button class="tab" data-class="mapeh">MAPEH</button>
                <button class="tab" data-class="gmrc">GMRC</button>
                <button class="tab" data-class="students">Students</button>
            </div>
        </div>
        
        <div class="leaderboard-container">
                <div class="leaderboard-header">
                    <div class="leaderboard-title">Student Rankings</div>
                    <div>
                        <button class="reset-btn" id="reset-stars">
                            <i class="fas fa-undo"></i> Reset All Stars
                        </button>
                    </div>
                </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Student Name</th>
                        <th>Stars</th>
                        <th class="rank-column">Rank Level</th>
                        <th>Add Stars</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Student rows will be populated by JavaScript -->
                </tbody>
            </table>
            
            <div id="save-notice" class="save-notice">
                <i class="fas fa-check-circle"></i> Progress saved successfully!
            </div>
            
            <div id="reset-notice" class="reset-notice">
                <i class="fas fa-info-circle"></i> All stars have been reset to zero!
            </div>
            
        </div>

    <!-- Students Panel (separate tab) -->
    <div id="students-panel" style="display:none; margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin: 10px 0 15px; color: #3498db;">Students</h2>
            <div>
                <button class="student-management-btn" id="manage-students-panel">
                    <i class="fas fa-users-cog"></i> Manage Students
                </button>
            </div>
        </div>

        <div style="width:100%;">
            <section id="male-section" style="margin-bottom:30px;">
                <h3 style="color:#3498db; margin-bottom:10px;">Boys</h3>
                <div id="male-students-table"></div>
            </section>

            <section id="female-section" style="margin-bottom:30px;">
                <h3 style="color:#e84393; margin-bottom:10px;">Girls</h3>
                <div id="female-students-table"></div>
            </section>
        </div>
    </div>
        </div>
    </div>

    <!-- Student Management Modal -->
    <div class="modal" id="student-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add New Student</h3>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <form id="student-form">
                <input type="hidden" id="student-id">
                <div class="form-group">
                    <label for="student-name">Student Name</label>
                    <input type="text" id="student-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="student-gender">Gender</label>
                    <select id="student-gender" class="form-control" required>
                        <option value="boy">Boy</option>
                        <option value="girl">Girl</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="student-lrn">LRN</label>
                    <input type="text" id="student-lrn" class="form-control" placeholder="Learner Reference Number">
                </div>
                <div class="form-group">
                    <label for="student-birthday">Birthday</label>
                    <input type="date" id="student-birthday" class="form-control">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-form">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-student">Save Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Floating action button for mobile -->
    <button class="floating-add-stars" id="floating-add-stars" title="Add Stars">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
        // Supabase client (same project as index.html)
        const SUPABASE_URL = 'https://ttiwsehtmipvvpdxqvma.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0aXdzZWh0bWlwdnZwZHhxdm1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5Mjc0MDQsImV4cCI6MjA3MzUwMzQwNH0.c3l9tC3-zurHxuqucsJ-PKGkG5yKCwfQTIBKSJXJYpQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // All Grade 5 students with subject-specific stars (initial template)
        const initialStudentsTemplate = [
            // Boys
            { 
                id: 1, 
                name: "DEHILO, ALDRIN LOMA", 
                gender: "boy", 
                stars: {
                    overall: 15,
                    english: 3,
                    filipino: 2,
                    mathematics: 4,
                    science: 2,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 1
                }
            },
            { 
                id: 2, 
                name: "LALUNA, JM SALAC", 
                gender: "boy", 
                stars: {
                    overall: 12,
                    english: 2,
                    filipino: 2,
                    mathematics: 3,
                    science: 2,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 3, 
                name: "ONTEVEROS, PAUL SIDRICHE CALWIT", 
                gender: "boy", 
                stars: {
                    overall: 14,
                    english: 3,
                    filipino: 3,
                    mathematics: 3,
                    science: 2,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 4, 
                name: "OPORTO, JULIMHARR MASONG", 
                gender: "boy", 
                stars: {
                    overall: 10,
                    english: 2,
                    filipino: 2,
                    mathematics: 2,
                    science: 1,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 5, 
                name: "OPORTO, JULIREIGH MASONG", 
                gender: "boy", 
                stars: {
                    overall: 8,
                    english: 1,
                    filipino: 1,
                    mathematics: 2,
                    science: 1,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 6, 
                name: "OPORTO, RAYMOND MASONG", 
                gender: "boy", 
                stars: {
                    overall: 11,
                    english: 2,
                    filipino: 2,
                    mathematics: 3,
                    science: 1,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 7, 
                name: "PAGANDA, ERNEST GEOF DELACERNA", 
                gender: "boy", 
                stars: {
                    overall: 13,
                    english: 3,
                    filipino: 2,
                    mathematics: 3,
                    science: 2,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 8, 
                name: "ROMANILLOS, JAYSON PARATAN", 
                gender: "boy", 
                stars: {
                    overall: 9,
                    english: 2,
                    filipino: 1,
                    mathematics: 2,
                    science: 1,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 9, 
                name: "TABUSO, JERALD PARAGAS", 
                gender: "boy", 
                stars: {
                    overall: 7,
                    english: 1,
                    filipino: 1,
                    mathematics: 1,
                    science: 1,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            
            // Girls
            { 
                id: 10, 
                name: "ARCILLAS, JUDY ANN ABISO", 
                gender: "girl", 
                stars: {
                    overall: 16,
                    english: 4,
                    filipino: 3,
                    mathematics: 3,
                    science: 2,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 1
                }
            },
            { 
                id: 11, 
                name: "ARMERO, ANNIE JOY VILLAVITO", 
                gender: "girl", 
                stars: {
                    overall: 14,
                    english: 3,
                    filipino: 3,
                    mathematics: 3,
                    science: 2,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 12, 
                name: "BERJAME, SHAIRA JANE BARCELON", 
                gender: "girl", 
                stars: {
                    overall: 12,
                    english: 3,
                    filipino: 2,
                    mathematics: 2,
                    science: 1,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 1
                }
            },
            { 
                id: 13, 
                name: "LLEDO, CHRISTEL FAITH MALOLOY-ON", 
                gender: "girl", 
                stars: {
                    overall: 13,
                    english: 3,
                    filipino: 3,
                    mathematics: 2,
                    science: 2,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 14, 
                name: "MONTEALTO, MARCHELYN GULO", 
                gender: "girl", 
                stars: {
                    overall: 11,
                    english: 2,
                    filipino: 2,
                    mathematics: 2,
                    science: 1,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 1
                }
            },
            { 
                id: 15, 
                name: "OBIDO, NOVIE JANE", 
                gender: "girl", 
                stars: {
                    overall: 9,
                    english: 2,
                    filipino: 1,
                    mathematics: 2,
                    science: 1,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 16, 
                name: "REMASOG, WANEDHALLE FAITH ARMERO", 
                gender: "girl", 
                stars: {
                    overall: 15,
                    english: 3,
                    filipino: 3,
                    mathematics: 3,
                    science: 2,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 1
                }
            },
            { 
                id: 17, 
                name: "REPDOS, MARJEL FATE NACION", 
                gender: "girl", 
                stars: {
                    overall: 10,
                    english: 2,
                    filipino: 2,
                    mathematics: 2,
                    science: 1,
                    aralingPanlipunan: 1,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 0
                }
            },
            { 
                id: 18, 
                name: "SINADJAN, EVA SEPRYL GANUB", 
                gender: "girl", 
                stars: {
                    overall: 17,
                    english: 4,
                    filipino: 3,
                    mathematics: 3,
                    science: 2,
                    aralingPanlipunan: 2,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 1
                }
            },
            { 
                id: 19, 
                name: "SINGSON, JAYNIEZELLE NICOLE AUSTRIA", 
                gender: "girl", 
                stars: {
                    overall: 18,
                    english: 4,
                    filipino: 4,
                    mathematics: 3,
                    science: 2,
                    aralingPanlipunan: 2,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 1
                }
            },
            { 
                id: 20, 
                name: "VILLARUZ, PRINCESS MAE BERJAME", 
                gender: "girl", 
                stars: {
                    overall: 19,
                    english: 4,
                    filipino: 4,
                    mathematics: 4,
                    science: 2,
                    aralingPanlipunan: 2,
                    epp: 1,
                    mapeh: 1,
                    gmrc: 1
                }
            }
        ];

        // Function to calculate rank based on total stars
        function calculateRank(stars) {
            // Use the exact ranges provided
            if (stars >= 0 && stars <= 75) return { name: "Warrior Explorer", class: "warrior-explorer", icon: "âš”ï¸" };
            if (stars >= 76 && stars <= 150) return { name: "Elite Apprentice", class: "elite-apprentice", icon: "ðŸŽ“" };
            if (stars >= 151 && stars <= 250) return { name: "Master Scholar", class: "master-scholar", icon: "ðŸ“š" };
            if (stars >= 251 && stars <= 350) return { name: "Grandmaster Achiever", class: "grandmaster-achiever", icon: "ðŸ†" };
            if (stars >= 351 && stars <= 450) return { name: "Epic Strategist", class: "epic-strategist", icon: "ðŸ§ " };
            if (stars >= 451 && stars <= 550) return { name: "Legend Mastermind", class: "legend-mastermind", icon: "ðŸŒŸ" };
            if (stars >= 551 && stars <= 700) return { name: "Mythic Luminary", class: "mythic-luminary", icon: "âœ¨" };
            if (stars >= 701 && stars <= 800) return { name: "Mythical Visionary", class: "mythical-visionary", icon: "ðŸ”®" };
            if (stars >= 801 && stars <= 1000) return { name: "Mythical Prodigy", class: "mythical-prodigy", icon: "ðŸš€" };
            return { name: "Mythical Immortal Scholar", class: "mythical-immortal", icon: "ðŸ‘‘" };
        }

        // DOM elements
        const tabs = document.querySelectorAll('.tab');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const activeSubjectSpan = document.getElementById('active-subject');
        const totalStarsSpan = document.getElementById('total-stars');
        const topStudentSpan = document.getElementById('top-student');
        const saveNotice = document.getElementById('save-notice');
        const resetNotice = document.getElementById('reset-notice');
        const studentList = document.getElementById('student-list');
        const resetBtn = document.getElementById('reset-stars');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const loggedInUserSpan = document.getElementById('logged-in-user');
        const floatingAddStarsBtn = document.getElementById('floating-add-stars');
        const manageStudentsBtn = document.getElementById('manage-students');
        const studentModal = document.getElementById('student-modal');
        const modalTitle = document.getElementById('modal-title');
        const studentForm = document.getElementById('student-form');
        const studentIdInput = document.getElementById('student-id');
        const studentNameInput = document.getElementById('student-name');
        const studentGenderSelect = document.getElementById('student-gender');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelFormBtn = document.getElementById('cancel-form');

        let currentSubject = 'overall';
        let allStudents = [];
        let currentUser = "Teacher"; // Default user for demo purposes
        let editingStudentId = null;

        // Initialize the application
        async function init() {
            // Load data (from Supabase or local)
            await loadData();

            // Set up event listeners
            setupEventListeners();

            // Render the initial leaderboard
            renderLeaderboard(currentSubject);

            // Render student cards
            renderStudentCards();

            // Display username (from supabase if available)
            await displayUsername();
        }

        // Save data: persist to Supabase when user logged in (using Supabase session), otherwise use localStorage
        async function saveData() {
            // Prefer Supabase session (get current user email)
            let supEmail = null;
            try {
                const { data, error } = await supabase.auth.getUser();
                if (!error && data && data.user && data.user.email) supEmail = data.user.email;
            } catch (e) {
                console.warn('supabase getUser error in saveData', e);
            }

            if (supEmail) {
                try {
                    const payload = allStudents.map(s => ({
                        id: s.id,
                        name: s.name,
                        lrn: s.lrn || null,
                        gender: s.gender,
                        birthday: s.birthday || null,
                        stars: s.stars,
                        owner_email: supEmail
                    }));
                    const { error } = await supabase.from('students').upsert(payload, { onConflict: ['id'] });
                    if (error) throw error;
                } catch (err) {
                    console.error('Supabase save error', err.message || err);
                }
            } else {
                // fallback to legacy localStorage
                try { localStorage.setItem('grade5Leaderboard', JSON.stringify(allStudents)); } catch (e) { console.error(e); }
            }
            showSaveNotice();
        }

        // Load data: try Supabase per-account using Supabase session email, otherwise localStorage or template
        async function loadData() {
            // Try Supabase session first
            let supEmail = null;
            try {
                const { data, error } = await supabase.auth.getUser();
                if (!error && data && data.user && data.user.email) supEmail = data.user.email;
            } catch (e) {
                console.warn('supabase getUser error in loadData', e);
            }

            if (supEmail) {
                try {
                    const { data, error } = await supabase.from('students').select('*').eq('owner_email', supEmail);
                    if (error) throw error;
                    if (data && data.length) {
                        allStudents = data.map(r => ({
                            id: r.id,
                            name: r.name,
                            lrn: r.lrn || null,
                            gender: r.gender,
                            birthday: r.birthday || null,
                            stars: r.stars || {
                                overall:0,english:0,filipino:0,mathematics:0,science:0,aralingPanlipunan:0,epp:0,mapeh:0,gmrc:0
                            }
                        }));
                        return;
                    }
                } catch (err) {
                    console.error('Supabase load error', err.message || err);
                }
            }

            // fallback to localStorage or template
            let savedData = null;
            try {
                savedData = localStorage.getItem('grade5Leaderboard');
            } catch (e) { savedData = null; }

            if (savedData) {
                try { allStudents = JSON.parse(savedData); } catch (e) { allStudents = JSON.parse(JSON.stringify(initialStudentsTemplate)); }
            } else {
                allStudents = JSON.parse(JSON.stringify(initialStudentsTemplate));
                await saveData();
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Update current subject
                    currentSubject = tab.getAttribute('data-class');
                    
                    // If Students tab, show students panel
                    const studentsPanel = document.getElementById('students-panel');
                    const leaderboardContainer = document.querySelector('.leaderboard-container');
                    if (currentSubject === 'students') {
                        if (studentsPanel) studentsPanel.style.display = 'block';
                        if (leaderboardContainer) leaderboardContainer.style.display = 'none';
                        renderStudentsPanel();
                    } else {
                        if (studentsPanel) studentsPanel.style.display = 'none';
                        if (leaderboardContainer) leaderboardContainer.style.display = 'block';
                        // Render the new leaderboard
                        renderLeaderboard(currentSubject);
                    }
                });
            });
            
            // Reset button event
            resetBtn.addEventListener('click', resetAllStars);
            
            // Manage students button in Students panel (open modal)
            const manageStudentsPanelBtn = document.getElementById('manage-students-panel');
            if (manageStudentsPanelBtn) manageStudentsPanelBtn.addEventListener('click', showStudentManagement);

            // Also wire original manage students button (on leaderboard header) if present
            if (manageStudentsBtn) manageStudentsBtn.addEventListener('click', showStudentManagement);

            // Logout button event
            logoutBtn.addEventListener('click', logoutUser);
            
            // Floating add stars button event
            floatingAddStarsBtn.addEventListener('click', () => {
                // Scroll to the first student's add stars input
                const firstInput = document.querySelector('.points-input');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
            
            // Manage students button event
            manageStudentsBtn.addEventListener('click', showStudentManagement);
            
            // Modal events
            closeModalBtn.addEventListener('click', closeModal);
            cancelFormBtn.addEventListener('click', closeModal);
            
            // Form submission
            studentForm.addEventListener('submit', handleStudentFormSubmit);
        }

        // Render the leaderboard for a specific subject
        function renderLeaderboard(subject) {
            // Clear the current leaderboard
            leaderboardBody.innerHTML = '';
            
            // Get students sorted by stars for the current subject
            const sortedStudents = [...allStudents].sort((a, b) => 
                b.stars[subject] - a.stars[subject]
            );
            
            // Update header stats
            updateHeaderStats(sortedStudents, subject);
            
            // Create rows for each student
            sortedStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.classList.add(student.gender);
                
                // Rank cell
                const rankCell = document.createElement('td');
                rankCell.classList.add('rank');
                if (index === 0) rankCell.classList.add('rank-1');
                else if (index === 1) rankCell.classList.add('rank-2');
                else if (index === 2) rankCell.classList.add('rank-3');
                rankCell.textContent = index + 1;
                
                // Name cell
                const nameCell = document.createElement('td');
                nameCell.classList.add('student-name');
                
                const genderIcon = document.createElement('span');
                genderIcon.classList.add('gender-icon');
                genderIcon.innerHTML = student.gender === 'boy' ? 
                    '<i class="fas fa-mars"></i>' : 
                    '<i class="fas fa-venus"></i>';
                
                nameCell.appendChild(genderIcon);
                nameCell.appendChild(document.createTextNode(student.name));
                
                // Stars cell
                const starsCell = document.createElement('td');
                starsCell.classList.add('stars');

                // Add up to 5 star icons
                const starCount = student.stars[subject];
                const maxStarsToShow = Math.min(starCount, 5);
                for (let i = 0; i < maxStarsToShow; i++) {
                    const starIcon = document.createElement('i');
                    starIcon.classList.add('fas', 'fa-star', 'star');
                    starsCell.appendChild(starIcon);
                }

                // Add star count text
                const starCountText = document.createElement('span');
                starCountText.textContent = ` (${starCount})`;
                starsCell.appendChild(starCountText);
                
                // Rank level cell
                const rankLevelCell = document.createElement('td');
                const rankInfo = calculateRank(student.stars.overall);
                
                const rankBadge = document.createElement('span');
                rankBadge.classList.add('rank-badge', rankInfo.class);
                rankBadge.textContent = rankInfo.icon;
                
                const rankText = document.createElement('span');
                rankText.textContent = rankInfo.name;
                
                rankLevelCell.appendChild(rankBadge);
                rankLevelCell.appendChild(rankText);
                
                // Add stars cell
                const addStarsCell = document.createElement('td');
                addStarsCell.classList.add('add-stars-cell');
                
                const inputGroup = document.createElement('div');
                inputGroup.style.display = 'flex';
                inputGroup.style.alignItems = 'center';
                
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '1';
                input.max = '5';
                input.value = '1';
                input.classList.add('points-input');
                
                const button = document.createElement('button');
                button.classList.add('add-stars-btn');
                button.innerHTML = '<i class="fas fa-plus"></i> Add';
                
                // Add event listener to the button
                button.addEventListener('click', () => {
                    const starsToAdd = parseInt(input.value) || 1;
                    addStars(student.id, starsToAdd, subject);
                });
                
                inputGroup.appendChild(input);
                inputGroup.appendChild(button);
                addStarsCell.appendChild(inputGroup);
                
                // Append all cells to the row
                row.appendChild(rankCell);
                row.appendChild(nameCell);
                row.appendChild(starsCell);
                row.appendChild(rankLevelCell);
                row.appendChild(addStarsCell);
                
                // Append row to the table body
                leaderboardBody.appendChild(row);
            });
        }

        // Render student cards
        function renderStudentCards() {
            studentList.innerHTML = '';
            
            allStudents.forEach(student => {
                const card = document.createElement('div');
                card.classList.add('student-card', student.gender);
                
                const avatar = document.createElement('div');
                avatar.classList.add('student-avatar');
                avatar.textContent = student.name.charAt(0);
                
                const info = document.createElement('div');
                info.classList.add('student-info');
                
                const name = document.createElement('div');
                name.classList.add('student-name');
                name.textContent = student.name;
                
                const stars = document.createElement('div');
                stars.classList.add('student-stars');
                stars.innerHTML = `<i class="fas fa-star"></i> ${student.stars.overall} Stars`;
                
                // Add rank information to card
                const rankInfo = calculateRank(student.stars.overall);
                const rank = document.createElement('div');
                rank.classList.add('student-rank');
                
                const rankBadge = document.createElement('span');
                rankBadge.classList.add('rank-badge', rankInfo.class);
                rankBadge.textContent = rankInfo.icon;
                
                const rankText = document.createElement('span');
                rankText.textContent = rankInfo.name;
                
                rank.appendChild(rankBadge);
                rank.appendChild(rankText);
                
                info.appendChild(name);
                info.appendChild(stars);
                info.appendChild(rank);
                
                // Add action buttons
                const actions = document.createElement('div');
                actions.classList.add('student-actions');
                
                const editBtn = document.createElement('button');
                editBtn.classList.add('student-action-btn');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = 'Edit Student';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editStudent(student.id);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('student-action-btn');
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Delete Student';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteStudent(student.id);
                });
                
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                
                card.appendChild(avatar);
                card.appendChild(info);
                card.appendChild(actions);
                
                studentList.appendChild(card);
            });
            // Also update Students panel tables (male/female alphabetical)
            renderStudentsPanel();
        }

        // Compute age from birthday (YYYY-MM-DD)
        function computeAge(birthday) {
            if (!birthday) return '';
            const b = new Date(birthday);
            if (isNaN(b)) return '';
            const today = new Date();
            let age = today.getFullYear() - b.getFullYear();
            const m = today.getMonth() - b.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < b.getDate())) {
                age--;
            }
            return age;
        }

        // Render the Students panel: separate male and female, alphabetical
        function renderStudentsPanel() {
            const maleDiv = document.getElementById('male-students-table');
            const femaleDiv = document.getElementById('female-students-table');
            if (!maleDiv || !femaleDiv) return;

            const males = allStudents.filter(s => s.gender === 'boy').sort((a,b)=> a.name.localeCompare(b.name));
            const females = allStudents.filter(s => s.gender === 'girl').sort((a,b)=> a.name.localeCompare(b.name));

            function buildTable(list) {
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                const thead = document.createElement('thead');
                thead.innerHTML = `<tr><th>Name</th><th>LRN</th><th>Gender</th><th>Birthday</th><th>Age</th><th>Stars</th><th>Actions</th></tr>`;
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                list.forEach(s => {
                    const tr = document.createElement('tr');
                    // create cells
                    const nameTd = document.createElement('td'); nameTd.textContent = s.name;
                    const lrnTd = document.createElement('td'); lrnTd.textContent = s.lrn || '';
                    const genderTd = document.createElement('td'); genderTd.textContent = s.gender === 'boy' ? 'Male' : 'Female';
                    const bdayTd = document.createElement('td'); bdayTd.textContent = s.birthday || '';
                    const ageTd = document.createElement('td'); ageTd.textContent = computeAge(s.birthday);
                    const starsTd = document.createElement('td'); starsTd.textContent = s.stars?.overall ?? 0;

                    // actions
                    const actionsTd = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-secondary';
                    editBtn.style.marginRight = '8px';
                    editBtn.textContent = 'Edit';
                    editBtn.addEventListener('click', (e) => { e.stopPropagation(); editStudent(s.id); });

                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-secondary';
                    delBtn.style.background = '#e74c3c';
                    delBtn.style.color = 'white';
                    delBtn.textContent = 'Delete';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteStudent(s.id); });

                    actionsTd.appendChild(editBtn);
                    actionsTd.appendChild(delBtn);

                    tr.appendChild(nameTd);
                    tr.appendChild(lrnTd);
                    tr.appendChild(genderTd);
                    tr.appendChild(bdayTd);
                    tr.appendChild(ageTd);
                    tr.appendChild(starsTd);
                    tr.appendChild(actionsTd);

                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                return table;
            }

            maleDiv.innerHTML = '';
            femaleDiv.innerHTML = '';
            if (males.length) maleDiv.appendChild(buildTable(males)); else maleDiv.innerHTML = '<p>No male students</p>';
            if (females.length) femaleDiv.appendChild(buildTable(females)); else femaleDiv.innerHTML = '<p>No female students</p>';
        }

        // Update header statistics
        function updateHeaderStats(students, subject) {
            // Format subject name
            const subjectNames = {
                overall: "Overall Stars",
                english: "English",
                filipino: "Filipino",
                mathematics: "Mathematics",
                science: "Science",
                aralingPanlipunan: "Araling Panlipunan",
                epp: "EPP",
                mapeh: "MAPEH",
                gmrc: "GMRC"
            };
            
            // Update active subject display
            activeSubjectSpan.textContent = subjectNames[subject];
            
            // Calculate total stars
            let totalStars = 0;
            if (subject === 'overall') {
                totalStars = students.reduce((total, student) => total + student.stars.overall, 0);
            } else {
                totalStars = students.reduce((total, student) => total + student.stars[subject], 0);
            }
            totalStarsSpan.textContent = totalStars;
            
            // Get top student
            const topStudent = students[0];
            if (topStudent) {
                topStudentSpan.textContent = topStudent.name;
            }
        }

        // Add stars to a student
        function addStars(studentId, stars, subject) {
            // Find the student
            const student = allStudents.find(s => s.id === studentId);
            if (student) {
                // Add stars to the specific subject
                student.stars[subject] += stars;

                // If it's not the overall tab, update the overall stars
                if (subject !== 'overall') {
                    student.stars.overall += stars;
                }

                // Re-render the leaderboard and cards
                renderLeaderboard(currentSubject);
                renderStudentCards();

                // Save the data for the current user/account
                saveData();
            }
        }

        // Show save notification
        function showSaveNotice() {
            saveNotice.style.display = 'block';
            setTimeout(() => {
                saveNotice.style.display = 'none';
            }, 3000);
        }
        
        // Show reset notification
        function showResetNotice() {
            resetNotice.style.display = 'block';
            setTimeout(() => {
                resetNotice.style.display = 'none';
            }, 3000);
        }

        // Reset all stars to zero
        function resetAllStars() {
            // Confirm with the user
            if (confirm("Are you sure you want to reset all stars to zero? This action cannot be undone.")) {
                // Reset all stars to 0
                allStudents.forEach(student => {
                    for (const subject in student.stars) {
                        student.stars[subject] = 0;
                    }
                });
                
                // Re-render the leaderboard and cards
                renderLeaderboard(currentSubject);
                renderStudentCards();
                
                // Save the data
                saveData();
                
                // Show reset notification
                showResetNotice();
            }
        }

        // Display the logged-in username (try Supabase auth first, fall back to localStorage)
        async function displayUsername() {
            let displayName = null;
            try {
                const { data, error } = await supabase.auth.getUser();
                if (!error && data && data.user) {
                    const user = data.user;
                    // prefer metadata name when available
                    if (user.user_metadata && user.user_metadata.name) displayName = user.user_metadata.name;
                    else if (user.email) displayName = user.email;
                }
            } catch (err) {
                console.warn('supabase.auth.getUser error', err);
            }

            // Fallback to localStorage
            if (!displayName) {
                let currentUser = null;
                try { currentUser = JSON.parse(localStorage.getItem('currentUser')); } catch(e){}
                if (currentUser && currentUser.isAuthenticated) {
                    displayName = currentUser.username;
                }
            }

            // Apply to UI
            if (displayName) {
                userAvatar.textContent = displayName.charAt(0).toUpperCase();
                loggedInUserSpan.textContent = displayName;
                const userNameElem = document.getElementById('user-name');
                if (userNameElem) userNameElem.textContent = displayName;
            } else {
                userAvatar.textContent = "T";
                loggedInUserSpan.textContent = "Teacher";
            }
        }

        // Logout the user (Supabase sign-out + clear legacy localStorage marker)
        async function logoutUser() {
            try {
                await supabase.auth.signOut();
            } catch (err) {
                console.warn('supabase signOut error', err);
            }
            try { localStorage.removeItem('currentUser'); } catch (e) {}
            window.location.href = 'index.html';
        }

        // Show student management modal
        function showStudentManagement() {
            modalTitle.textContent = "Add New Student";
            studentIdInput.value = "";
            studentNameInput.value = "";
            studentGenderSelect.value = "boy";
            editingStudentId = null;
            studentModal.style.display = "flex";
        }

        // Close modal
        function closeModal() {
            studentModal.style.display = "none";
        }

        // Close modal on overlay click or Escape key
        document.addEventListener('click', function(e) {
            if (e.target === studentModal) closeModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });

        // Handle student form submission (async so we await persistence)
        async function handleStudentFormSubmit(e) {
            e.preventDefault();
            
            const name = studentNameInput.value.trim();
            const gender = studentGenderSelect.value;
            const lrn = document.getElementById('student-lrn').value.trim();
            const birthday = document.getElementById('student-birthday').value || null;
            
            if (!name) {
                alert("Please enter a student name");
                return;
            }
            
            if (editingStudentId) {
                // Update existing student
                const student = allStudents.find(s => s.id === editingStudentId);
                if (student) {
                    student.name = name;
                    student.gender = gender;
                    student.lrn = lrn || null;
                    student.birthday = birthday;

                    // Persist update to Supabase if logged in
                    try{
                        // prefer Supabase session email
                        let supEmail = null;
                        try { const res = await supabase.auth.getUser(); if (res?.data?.user?.email) supEmail = res.data.user.email; } catch(e){}
                        if (supEmail) {
                            const payload = {
                                id: student.id,
                                name: student.name,
                                lrn: student.lrn,
                                gender: student.gender,
                                birthday: student.birthday,
                                stars: student.stars,
                                owner_email: supEmail
                            };
                            const { error } = await supabase.from('students').upsert(payload, { onConflict: ['id'] });
                            if (error) console.error('Upsert student error', error.message || error);
                        }
                    } catch(err){ console.error(err); }
                }
            } else {
                // Create new student
                const newId = allStudents.length > 0 ? Math.max(...allStudents.map(s => s.id)) + 1 : 1;
                
                const newStudent = {
                    id: newId,
                    name: name,
                    lrn: lrn || null,
                    gender: gender,
                    birthday: birthday,
                    stars: {
                        overall: 0,
                        english: 0,
                        filipino: 0,
                        mathematics: 0,
                        science: 0,
                        aralingPanlipunan: 0,
                        epp: 0,
                        mapeh: 0,
                        gmrc: 0
                    }
                };
                
                allStudents.push(newStudent);

                // Persist new student to Supabase if logged in (await so UI shows saved state)
                try{
                    let supEmail = null;
                    try { const res = await supabase.auth.getUser(); if (res?.data?.user?.email) supEmail = res.data.user.email; } catch(e){}
                    if (supEmail) {
                        const payload = {
                            id: newStudent.id,
                            name: newStudent.name,
                            lrn: newStudent.lrn,
                            gender: newStudent.gender,
                            birthday: newStudent.birthday,
                            stars: newStudent.stars,
                            owner_email: supEmail
                        };
                        const { error } = await supabase.from('students').insert(payload);
                        if (error) console.error('Insert student error', error.message || error);
                    }
                } catch(err){ console.error(err); }
            }
            
            // Save and refresh (await saveData as it may persist to Supabase)
            await saveData();
            renderLeaderboard(currentSubject);
            renderStudentCards();
            closeModal();
        }

        // Edit a student
        function editStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (student) {
                modalTitle.textContent = "Edit Student";
                studentIdInput.value = student.id;
                studentNameInput.value = student.name;
                studentGenderSelect.value = student.gender;
                document.getElementById('student-lrn').value = student.lrn || '';
                document.getElementById('student-birthday').value = student.birthday || '';
                editingStudentId = studentId;
                studentModal.style.display = "flex";
            }
        }

        // Delete a student
        async function deleteStudent(studentId) {
            if (confirm("Are you sure you want to delete this student? This action cannot be undone.")) {
                allStudents = allStudents.filter(s => s.id !== studentId);
                await saveData();
                renderLeaderboard(currentSubject);
                renderStudentCards();

                // Delete from Supabase if logged in
                try {
                    let supEmail = null;
                    try { const res = await supabase.auth.getUser(); if (res?.data?.user?.email) supEmail = res.data.user.email; } catch(e){}
                    if (supEmail) {
                        const { error } = await supabase.from('students').delete().eq('id', studentId).eq('owner_email', supEmail);
                        if (error) console.error('Delete student error', error.message || error);
                    }
                } catch (err) { console.error(err); }
            }
        }

        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
